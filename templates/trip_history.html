{% extends "layout.html" %}

{% block title %}Trip History{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

<style>
    .status-Arrived { color: green; font-weight: bold; }
    .status-Delayed { color: red; font-weight: bold; }
    .status-Pending { color: orange; font-weight: bold; }

    /* Status Filter Buttons */
    .status-btn {
        margin-right: 8px;
        border-radius: 20px;
        padding: 6px 16px;
        font-weight: 600;
        cursor: pointer;
    }

    .status-btn.active {
        background: black !important;
        color: white !important;
        border: 2px solid black !important;
    }
</style>
{% endblock %}



{% block content %}
<div class="container-fluid p-3">
    <h2 class="mb-3">Trip History</h2>

    <!-- FILTER FORM -->
    <form id="filterForm" class="row g-2 mb-3">
        <div class="col-md-3 col-lg-2"><input type="text" name="vehicle" class="form-control" placeholder="Vehicle No" value="{{ request.args.get('vehicle', '') }}"></div>
        <div class="col-md-3 col-lg-2"><input type="text" name="indent" class="form-control" placeholder="Indent ID" value="{{ request.args.get('indent', '') }}"></div>
        <div class="col-md-3 col-lg-2"><input type="date" name="start_date" class="form-control" value="{{ request.args.get('start_date', '') }}"></div>
        <div class="col-md-3 col-lg-2"><input type="date" name="end_date" class="form-control" value="{{ request.args.get('end_date', '') }}"></div>

        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filter</button>
            <a href="/trip-history" class="btn btn-secondary">Clear</a>
        </div>
    </form>


    <!-- ‚≠ê STATUS FILTER BUTTONS (NO DROPDOWN) -->
    <div class="mb-3">
        <button class="btn btn-outline-dark status-btn active" data-status="">All</button>
        <button class="btn btn-outline-success status-btn" data-status="Arrived">üü¢ Arrived</button>
        <button class="btn btn-outline-danger status-btn" data-status="Delayed">üî¥ Delayed</button>
        <button class="btn btn-outline-warning status-btn" data-status="Pending">üü† Pending</button>
    </div>


    <!-- TABLE -->
    <div class="table-responsive">
        <table id="tripTable" class="display nowrap table table-striped table-bordered w-100">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Indent ID</th>
                    <th>Vehicle</th>
                    <th>Driver</th>
                    <th>Pickup</th>
                    <th>Drop</th>
                    <th>Total Drops</th>
                    <th>Exit</th>
                    <th>ETA</th>
                    <th>Actual</th>
                    <th>Distance</th>
                    <th>Duration</th>
                    <th>Customers</th>
                    <th>POD</th>
                    <th>Status</th>
                    <th>Action</th>
                    <th>Created</th>
                </tr>
            </thead>

            <tbody>
                {% for trip in trips %}
                <tr data-id="{{ trip.id }}">
                    <td>{{ trip.id }}</td>
                    <td>{{ trip.indent_id }}</td>
                    <td>{{ trip.vehicle_no }}</td>
                    <td>{{ trip.driver_name }}</td>
                    <td>{{ trip.pickup }}</td>
                    <td>{{ trip.drop_location }}</td>
                    <td>{{ trip.total_drops }}</td>
                    <td>{{ trip.exit_time }}</td>
                    <td>{{ trip.eta_arrival_time }}</td>

                    <td>
                        <input type="datetime-local" class="form-control actual-arrival"
                            value="{{ trip.actual_arrival_time|default('', true)|replace(' ', 'T') }}">
                    </td>

                    <td>{{ trip.total_distance }}</td>
                    <td>{{ trip.duration_hours }}</td>

                    <td>
                        {% for cust in trip.customer_details %}
                        <div>{{ cust.name }} ({{ cust.mobile }})</div>
                        {% endfor %}
                    </td>

                    <td>
                        <input type="text" class="form-control pod-url" placeholder="POD URL"
                            value="{{ trip.pod_url or '' }}">
                    </td>

                    <td class="status-{{ trip.status }}">{{ trip.status }}</td>

                    <td><button class="btn btn-sm btn-success save-trip">Save</button></td>

                    <td>{{ trip.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>

        </table>
    </div>
</div>
{% endblock %}




{% block scripts %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>


<script>
$(document).ready(function () {

    // DATATABLE INITIALISATION
    var table = $('#tripTable').DataTable({
        dom: 'Bfrtip',
        scrollX: true,
        pageLength: 10,
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
    });

    // ‚≠ê STATUS FILTER BUTTON WORKING FIXED
    $('.status-btn').on('click', function () {

        $('.status-btn').removeClass('active');
        $(this).addClass('active');

        var status = $(this).data('status');

        // STATUS COLUMN INDEX = 14
        table.column(14).search(status).draw();
    });



    // SAVE TRIP
    $('.save-trip').on('click', function () {
        var row = $(this).closest('tr');
        var trip_id = row.data('id');
        var actual_arrival = row.find('.actual-arrival').val();
        var pod_url = row.find('.pod-url').val();

        if (!actual_arrival || !pod_url) {
            alert('Please enter both Actual Arrival Time and POD URL.');
            return;
        }

        var btn = $(this);
        btn.prop('disabled', true).text('Saving...');

        $.ajax({
            url: '/update-trip',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                trip_id: trip_id,
                actual_arrival_time: actual_arrival,
                pod_url: pod_url
            }),
            success: function (res) {
                alert(res.message || "Trip Updated!");
                location.reload();
            },
            error: function () {
                alert("Error updating trip!");
                btn.prop('disabled', false).text('Save');
            }
        });
    });

});
</script>
{% endblock %}
